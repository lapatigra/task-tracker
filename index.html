<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-title" content="–¢—Ä–µ–∫–µ—Ä">
    <title>–¢—Ä–µ–∫–µ—Ä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
            min-height: 100vh;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            color: #e0e0e0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 8px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 12px 16px;
            margin-bottom: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #ff9a56;
            margin-bottom: 8px;
            text-align: center;
        }

        .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .month-btn {
            background: #ff6b35;
            color: white;
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .month-btn:active { transform: scale(0.95); background: #ff5722; }

        .current-month {
            font-size: 17px;
            font-weight: 600;
            color: #ff9a56;
            min-width: 140px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .tab {
            flex: 1;
            background: rgba(30, 30, 30, 0.9);
            border: none;
            padding: 8px 4px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #999;
        }

        .tab.active {
            background: rgba(40, 40, 40, 0.95);
            color: #ff9a56;
            box-shadow: 0 4px 12px rgba(255, 154, 86, 0.3);
            border: 1px solid rgba(255, 154, 86, 0.3);
        }

        .content-section { display: none; }
        .content-section.active { display: block; }

        /* ===== –ó–ê–î–ê–ß–ò ===== */
        .tasks-grid {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .task-category { margin-bottom: 8px; }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            border-radius: 10px;
            margin-bottom: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }

        .category-header:active { transform: scale(0.98); }
        .category-name { font-size: 14px; }
        .category-toggle { font-size: 16px; transition: transform 0.3s; margin-left: 8px; }
        .category-toggle.collapsed { transform: rotate(-90deg); }

        .category-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }

        .category-content.collapsed { max-height: 0; opacity: 0; }

        .category-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 13px;
        }

        .week-container { margin-bottom: 10px; }

        .week-header {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
            padding-left: 4px;
            font-weight: 600;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .day-label { font-size: 9px; color: #999; margin-bottom: 2px; }

        .day-checkbox {
            width: 18px;
            height: 18px;
            appearance: none;
            border: 2px solid #444;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            background: #1a1a1a;
        }

        .day-checkbox:checked {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            border-color: #ff6b35;
        }

        .day-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 12px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===== */
        .stats-container {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 14px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            padding: 12px;
            border-radius: 12px;
            color: white;
        }

        .stat-label { font-size: 12px; opacity: 0.9; margin-bottom: 4px; }
        .stat-value { font-size: 26px; font-weight: 700; }

        .chart-container {
            margin-top: 14px;
            background: #2a2a2a;
            padding: 12px;
            border-radius: 12px;
        }

        .chart-title {
            font-size: 15px;
            font-weight: 600;
            color: #ff9a56;
            margin-bottom: 12px;
            text-align: center;
        }

        .bar-chart { display: flex; flex-direction: column; gap: 10px; }

        .bar-item { display: flex; align-items: center; gap: 8px; }

        .bar-label { min-width: 90px; font-size: 13px; color: #ccc; }

        .bar-track {
            flex: 1;
            height: 26px;
            background: #1a1a1a;
            border-radius: 13px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            border-radius: 13px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-size: 11px;
            font-weight: 600;
            transition: width 0.5s ease;
        }

        .summary-list { display: flex; flex-direction: column; gap: 8px; }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #2a2a2a;
            border-radius: 10px;
        }

        .summary-category { font-weight: 600; color: #e0e0e0; font-size: 14px; }
        .summary-stats { display: flex; gap: 12px; font-size: 13px; }
        .summary-stat { display: flex; flex-direction: column; align-items: center; }
        .summary-stat-label { font-size: 10px; color: #999; }
        .summary-stat-value { font-weight: 700; color: #ff9a56; }

        /* ===== –¢–ê–ô–ú–ï–† ===== */
        .timer-card {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px 16px;
            margin-bottom: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .timer-settings-title {
            font-size: 17px;
            font-weight: 700;
            color: #ff9a56;
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .timer-setting-row:last-of-type { border-bottom: none; }

        .timer-setting-label {
            font-size: 15px;
            color: #ccc;
            font-weight: 500;
        }

        .timer-spinner {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .spinner-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #ff6b35;
            background: transparent;
            color: #ff9a56;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            line-height: 1;
        }

        .spinner-btn:active { background: #ff6b35; color: white; transform: scale(0.93); }

        .spinner-val {
            font-size: 17px;
            font-weight: 700;
            color: #fff;
            min-width: 50px;
            text-align: center;
        }

        .timer-start-btn {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.2s;
            letter-spacing: 1px;
        }

        .timer-start-btn:active { transform: scale(0.97); }

        /* –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º–µ—Ä */
        .timer-active {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
        }

        .timer-phase-label {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 3px;
            color: #ff9a56;
            margin-bottom: 4px;
        }

        .timer-round-label {
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
        }

        .timer-ring-wrap {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 28px;
        }

        .timer-ring {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .timer-ring-bg {
            fill: none;
            stroke: #2a2a2a;
            stroke-width: 12;
        }

        .timer-ring-progress {
            fill: none;
            stroke: #ff6b35;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s linear, stroke 0.4s;
        }

        .timer-digits {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: 800;
            color: #fff;
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
        }

        .timer-controls {
            display: flex;
            gap: 20px;
        }

        .timer-ctrl-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            font-size: 26px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-ctrl-btn:active { transform: scale(0.9); }

        .timer-ctrl-btn.pause { background: #ff6b35; color: white; }
        .timer-ctrl-btn.stop { background: #333; color: #bbb; border: 2px solid #444; }

        /* –∑–∞–≤–µ—Ä—à–µ–Ω–æ */
        .timer-done {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0 10px;
            gap: 12px;
        }

        .timer-done-icon { font-size: 60px; }

        .timer-done-text {
            font-size: 22px;
            font-weight: 700;
            color: #ff9a56;
            margin-bottom: 10px;
        }

        /* ===== –ú–´–®–¶–´ (—É–±—Ä–∞–Ω–æ) ===== */
        .muscle-tracker {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .muscle-grid { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; }

        .muscle-item {
            background: #2a2a2a;
            padding: 8px 12px;
            border-radius: 9px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .muscle-item.completed {
            background: linear-gradient(135deg, rgba(255, 154, 86, 0.2) 0%, rgba(255, 107, 53, 0.2) 100%);
            border: 1px solid rgba(255, 154, 86, 0.3);
        }

        .muscle-name { font-size: 14px; color: #e0e0e0; font-weight: 500; flex: 1; }
        .muscle-counter { display: flex; align-items: center; gap: 8px; }

        .muscle-btn {
            width: 30px;
            height: 30px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 7px;
            color: #ff9a56;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .muscle-btn:active { transform: scale(0.9); background: #222; }

        .muscle-btn.active {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            border-color: #ff6b35;
            color: white;
        }

        .muscle-count { min-width: 28px; text-align: center; font-size: 16px; font-weight: 700; color: #ff9a56; }

        .muscle-reset {
            width: 26px;
            height: 26px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .muscle-reset:active { transform: scale(0.9); color: #ff6b35; }


        /* ===== DRAG & DROP ===== */
        .drag-handle {
            cursor: grab;
            color: #666;
            font-size: 18px;
            padding: 0 6px;
            user-select: none;
            touch-action: none;
            flex-shrink: 0;
        }
        .drag-handle:active { cursor: grabbing; }
        .ex-handle { font-size: 15px; color: #555; padding: 0 4px; }

        .dragging {
            opacity: 0.45;
            transform: scale(0.98);
        }

        .drag-over-top {
            border-top: 2px solid #ff6b35 !important;
        }
        .drag-over-bottom {
            border-bottom: 2px solid #ff6b35 !important;
        }

        /* handle –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–¥–∞—á ‚Äî –≤ —à–∞–ø–∫–µ */
        .category-handle {
            cursor: grab;
            color: rgba(255,255,255,0.5);
            font-size: 16px;
            padding: 0 4px;
            user-select: none;
            touch-action: none;
        }

        /* ===== –ö–ù–û–ü–ö–ò –î–û–ë–ê–í–õ–ï–ù–ò–Ø ===== */
        .add-category-btn {
            background: transparent;
            color: #ff9a56;
            border: 2px dashed rgba(255, 154, 86, 0.5);
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            width: 100%;
            transition: all 0.25s;
            letter-spacing: 0.3px;
        }

        .add-category-btn:hover {
            background: rgba(255, 154, 86, 0.08);
            border-color: #ff9a56;
        }

        .add-category-btn:active {
            transform: scale(0.98);
            background: rgba(255, 154, 86, 0.14);
        }

        /* ===== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: #2a2a2a;
            border-radius: 18px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(255, 154, 86, 0.3);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #ff9a56;
            margin-bottom: 16px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 10px 13px;
            color: #e0e0e0;
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
        }

        .modal-input:focus { border-color: #ff9a56; }

        .modal-buttons { display: flex; gap: 8px; }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            color: white;
        }

        .modal-btn.secondary { background: #1a1a1a; color: #999; border: 2px solid #444; }
        .modal-btn:active { transform: scale(0.98); }

        /* ===== –ü–†–û–ì–†–ê–ú–ú–ê –¢–†–ï–ù–ò–†–û–í–û–ö ===== */
        .program-section {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 10px;
            margin-bottom: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 53, 0.1);
        }

        .program-add-btn {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .program-add-btn:active { transform: scale(0.98); }

        .program-group {
            background: #222;
            border-radius: 12px;
            margin-bottom: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 107, 53, 0.15);
        }

        .program-group-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(255, 154, 86, 0.25) 0%, rgba(255, 107, 53, 0.25) 100%);
            cursor: pointer;
            user-select: none;
            gap: 8px;
        }

        .program-group-header:active { opacity: 0.85; }

        .program-group-name {
            flex: 1;
            font-size: 14px;
            font-weight: 700;
            color: #ff9a56;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .program-group-toggle {
            font-size: 14px;
            color: #ff9a56;
            transition: transform 0.3s;
        }

        .program-group-toggle.collapsed { transform: rotate(-90deg); }

        .program-group-actions {
            display: flex;
            gap: 6px;
        }

        .program-icon-btn {
            width: 28px;
            height: 28px;
            border-radius: 7px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
        }

        .program-icon-btn:active { transform: scale(0.9); }

        .program-icon-btn.add { background: #ff6b35; color: white; }
        .program-icon-btn.delete { background: #333; color: #888; }
        .program-icon-btn.delete:active { color: #ff4444; }

        .program-group-body {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }

        .program-group-body.collapsed { max-height: 0; opacity: 0; }

        .program-exercise {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            gap: 8px;
        }

        .program-exercise-name {
            flex: 1;
            font-size: 14px;
            color: #ddd;
            line-height: 1.3;
        }

        .program-exercise-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .program-add-exercise-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 1px dashed rgba(255, 107, 53, 0.4);
            border-radius: 8px;
            color: #ff9a56;
            font-size: 13px;
            cursor: pointer;
            margin: 6px 0 4px;
            transition: all 0.2s;
        }

        .program-add-exercise-btn:active { background: rgba(255, 107, 53, 0.1); }

        /* ===== –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===== */
        .auth-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 24px;
            gap: 0;
        }

        .auth-screen.hidden { display: none; }

        .auth-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 800;
            color: #ff9a56;
            margin-bottom: 6px;
            text-align: center;
        }

        .auth-subtitle {
            font-size: 14px;
            color: #777;
            margin-bottom: 40px;
            text-align: center;
        }

        .google-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
            color: #1a1a1a;
            border: none;
            padding: 14px 24px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            max-width: 320px;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .google-btn:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        .google-icon {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
        }

        .auth-loading {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }

        /* –ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É–≥–ª—É */
        .user-avatar {
            position: fixed;
            bottom: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #ff6b35;
            cursor: pointer;
            z-index: 999;
            object-fit: cover;
            background: #333;
            display: none;
        }

        .user-avatar.visible { display: block; }

        .user-avatar-placeholder {
            position: fixed;
            bottom: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #ff6b35;
            cursor: pointer;
            z-index: 999;
            background: linear-gradient(135deg, #ff9a56, #ff6b35);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
        }

        .user-avatar-placeholder.visible { display: flex; }

        /* Popup –≤—ã—Ö–æ–¥–∞ */
        .signout-popup {
            position: fixed;
            bottom: 54px;
            right: 12px;
            background: #2a2a2a;
            border: 1px solid rgba(255,107,53,0.3);
            border-radius: 12px;
            padding: 8px;
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 4px;
            min-width: 160px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .signout-popup.visible { display: flex; }

        .signout-user {
            font-size: 12px;
            color: #888;
            padding: 4px 8px;
            border-bottom: 1px solid #333;
            margin-bottom: 4px;
        }

        .signout-btn {
            background: transparent;
            border: none;
            color: #ff6b35;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s;
        }

        .signout-btn:hover { background: rgba(255,107,53,0.1); }

        @media (max-width: 380px) {
            .days-grid { gap: 3px; }
            .day-checkbox { width: 16px; height: 16px; }
        }

        @media (min-width: 768px) {
            .container { max-width: 1400px; padding: 20px; }
            .header { margin-bottom: 16px; padding: 16px 20px; }
            .tasks-grid { padding: 16px; }

            #tasksGrid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 12px;
            }

            .task-category { margin-bottom: 0; }
            .tabs { max-width: 600px; margin: 0 auto 16px; }
            .stats-container { max-width: 1200px; margin: 0 auto 16px; }
            .muscle-tracker { max-width: 600px; margin: 0 auto; }
            .program-section { max-width: 700px; margin: 0 auto 16px; }
            .add-category-btn { grid-column: 1 / -1; }
        }

        @media (min-width: 1200px) {
            #tasksGrid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–¢—Ä–µ–∫–µ—Ä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏</h1>
            <div class="month-selector">
                <button class="month-btn" onclick="changeMonth(-1)">‚Üê</button>
                <div class="current-month" id="currentMonth"></div>
                <button class="month-btn" onclick="changeMonth(1)">‚Üí</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('tasks', this)">–ó–∞–¥–∞—á–∏</button>
            <button class="tab" onclick="switchTab('program', this)">–ü—Ä–æ–≥—Ä–∞–º–º–∞</button>
            <button class="tab" onclick="switchTab('timer', this)">–¢–∞–π–º–µ—Ä</button>
            <button class="tab" onclick="switchTab('month', this)">–ú–µ—Å—è—Ü</button>
            <button class="tab" onclick="switchTab('year', this)">–ì–æ–¥</button>
        </div>

        <!-- –ó–ê–î–ê–ß–ò -->
        <div id="tasksSection" class="content-section active">
            <div class="tasks-grid">
                <button class="add-category-btn" onclick="openAddCategoryModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                <div id="tasksGrid"></div>
            </div>
        </div>

        <!-- –ü–†–û–ì–†–ê–ú–ú–ê –¢–†–ï–ù–ò–†–û–í–û–ö -->
        <div id="programSection" class="content-section">
            <div class="program-section">
                <button class="program-add-btn" onclick="openAddGroupModal()">+ –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É (–¥–µ–Ω—å)</button>
                <div id="programGrid"></div>
            </div>
        </div>

        <!-- –¢–ê–ô–ú–ï–† -->
        <div id="timerSection" class="content-section">
            <div class="timer-card">
                <div class="timer-settings" id="timerSettings">
                    <div class="timer-settings-title">–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä</div>
                    <div class="timer-setting-row">
                        <span class="timer-setting-label">–†–∞—É–Ω–¥–æ–≤</span>
                        <div class="timer-spinner">
                            <button class="spinner-btn" onclick="adjustSetting('rounds',-1)">‚àí</button>
                            <span class="spinner-val" id="settingRounds">5</span>
                            <button class="spinner-btn" onclick="adjustSetting('rounds',1)">+</button>
                        </div>
                    </div>
                    <div class="timer-setting-row">
                        <span class="timer-setting-label">–†–∞–±–æ—Ç–∞</span>
                        <div class="timer-spinner">
                            <button class="spinner-btn" onclick="adjustSetting('work',-5)">‚àí</button>
                            <span class="spinner-val" id="settingWork">40 —Å</span>
                            <button class="spinner-btn" onclick="adjustSetting('work',5)">+</button>
                        </div>
                    </div>
                    <div class="timer-setting-row">
                        <span class="timer-setting-label">–û—Ç–¥—ã—Ö</span>
                        <div class="timer-spinner">
                            <button class="spinner-btn" onclick="adjustSetting('rest',-5)">‚àí</button>
                            <span class="spinner-val" id="settingRest">20 —Å</span>
                            <button class="spinner-btn" onclick="adjustSetting('rest',5)">+</button>
                        </div>
                    </div>
                    <div class="timer-setting-row">
                        <span class="timer-setting-label">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</span>
                        <div class="timer-spinner">
                            <button class="spinner-btn" onclick="adjustSetting('prep',-5)">‚àí</button>
                            <span class="spinner-val" id="settingPrep">10 —Å</span>
                            <button class="spinner-btn" onclick="adjustSetting('prep',5)">+</button>
                        </div>
                    </div>
                    <button class="timer-start-btn" onclick="startTimer()">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                </div>
                <div class="timer-active" id="timerActive" style="display:none">
                    <div class="timer-phase-label" id="timerPhaseLabel">–ü–û–î–ì–û–¢–û–í–ö–ê</div>
                    <div class="timer-round-label" id="timerRoundLabel">–†–∞—É–Ω–¥ 1 / 5</div>
                    <div class="timer-ring-wrap">
                        <svg class="timer-ring" viewBox="0 0 200 200">
                            <circle class="timer-ring-bg" cx="100" cy="100" r="88"/>
                            <circle class="timer-ring-progress" id="timerRingProgress" cx="100" cy="100" r="88" stroke-dasharray="553" stroke-dashoffset="0"/>
                        </svg>
                        <div class="timer-digits" id="timerDigits">10</div>
                    </div>
                    <div class="timer-controls">
                        <button class="timer-ctrl-btn pause" id="timerPauseBtn" onclick="togglePause()">‚è∏</button>
                        <button class="timer-ctrl-btn stop" onclick="stopTimer()">‚èπ</button>
                    </div>
                </div>
                <div class="timer-done" id="timerDone" style="display:none">
                    <div class="timer-done-icon">üéâ</div>
                    <div class="timer-done-text">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</div>
                    <button class="timer-start-btn" onclick="resetTimer()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ú–ï–°–Ø–¶ -->
        <div id="monthSection" class="content-section">
            <div class="stats-container">
                <h2 class="chart-title">–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                        <div class="stat-value" id="monthTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        <div class="stat-value" id="monthCompleted">0</div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
                    <div class="bar-chart" id="monthChart"></div>
                </div>
            </div>
        </div>

        <!-- –ì–û–î -->
        <div id="yearSection" class="content-section">
            <div class="stats-container">
                <h2 class="chart-title">–ò—Ç–æ–≥–∏ –≥–æ–¥–∞</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                        <div class="stat-value" id="yearTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                        <div class="stat-value" id="yearCompleted">0</div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
                    <div class="summary-list" id="yearSummary"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-logo">üèãÔ∏è</div>
        <div class="auth-title">–¢—Ä–µ–∫–µ—Ä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
        <div class="auth-subtitle">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
        <button class="google-btn" onclick="signInWithGoogle()">
            <svg class="google-icon" viewBox="0 0 48 48">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.36-8.16 2.36-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                <path fill="none" d="M0 0h48v48H0z"/>
            </svg>
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </button>
        <div class="auth-loading" id="authLoading" style="display:none">–í—Ö–æ–¥–∏–º...</div>
    </div>

    <!-- –ê–≤–∞—Ç–∞—Ä / –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <img class="user-avatar" id="userAvatar" onclick="toggleSignoutPopup()" alt="–ü—Ä–æ—Ñ–∏–ª—å">
    <div class="user-avatar-placeholder" id="userAvatarPlaceholder" onclick="toggleSignoutPopup()"></div>

    <!-- –ü–æ–ø–∞–ø –≤—ã—Ö–æ–¥–∞ -->
    <div class="signout-popup" id="signoutPopup">
        <div class="signout-user" id="signoutUserName"></div>
        <button class="signout-btn" onclick="signOutUser()">–í—ã–π—Ç–∏</button>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∑–∞–¥–∞—á -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
            <input type="text" id="newCategoryInput" class="modal-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" maxlength="20">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('addCategoryModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="addNewCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
    <div id="addGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</div>
            <input type="text" id="newGroupInput" class="modal-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–µ–Ω—å 1 ‚Äî –ì—Ä—É–¥—å" maxlength="40">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('addGroupModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="addNewGroup()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ -->
    <div id="addExerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ù–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>
            <input type="text" id="newExerciseInput" class="modal-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ñ–∏–º –ª—ë–∂–∞ 4√ó10" maxlength="60">
            <input type="hidden" id="newExerciseGroupId">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('addExerciseModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="addNewExercise()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

<script>
    // ==================== FIREBASE ====================
    const firebaseConfig = {
        apiKey: "AIzaSyBDr6IVKewAVwv7FqxChVRv5pylnsHTdTw",
        authDomain: "todo-8e256.firebaseapp.com",
        databaseURL: "https://todo-8e256-default-rtdb.firebaseio.com",
        projectId: "todo-8e256",
        storageBucket: "todo-8e256.firebasestorage.app",
        messagingSenderId: "659322901199",
        appId: "1:659322901199:web:a7819a4878706567e55dba"
    };

    let database = null;
    let auth = null;
    let isFirebaseEnabled = false;
    let currentUserId = null;

    try {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        auth = firebase.auth();
        isFirebaseEnabled = true;
    } catch (e) {
        console.log('Firebase init error:', e);
    }

    // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
    function signInWithGoogle() {
        if (!auth) return;
        document.getElementById('authLoading').style.display = 'block';
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => {
            console.log('Google auth error:', e);
            document.getElementById('authLoading').style.display = 'none';
        });
    }

    function signOutUser() {
        toggleSignoutPopup();
        if (auth) auth.signOut();
    }

    function toggleSignoutPopup() {
        const popup = document.getElementById('signoutPopup');
        popup.classList.toggle('visible');
    }

    // –ó–∞–∫—Ä—ã—Ç—å –ø–æ–ø–∞–ø –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', e => {
        const popup = document.getElementById('signoutPopup');
        const avatar = document.getElementById('userAvatar');
        const placeholder = document.getElementById('userAvatarPlaceholder');
        if (!popup.contains(e.target) && e.target !== avatar && e.target !== placeholder) {
            popup.classList.remove('visible');
        }
    });

    function onUserSignedIn(user) {
        currentUserId = user.uid;
        // –°–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        document.getElementById('authScreen').classList.add('hidden');
        // –ü–æ–∫–∞–∑–∞—Ç—å –∞–≤–∞—Ç–∞—Ä
        if (user.photoURL) {
            const img = document.getElementById('userAvatar');
            img.src = user.photoURL;
            img.classList.add('visible');
        } else {
            const ph = document.getElementById('userAvatarPlaceholder');
            ph.textContent = (user.displayName || user.email || 'U')[0].toUpperCase();
            ph.classList.add('visible');
        }
        // –ò–º—è –≤ –ø–æ–ø–∞–ø–µ
        document.getElementById('signoutUserName').textContent = user.displayName || user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        loadData().then(() => { updateDisplay(); });
    }

    function onUserSignedOut() {
        currentUserId = null;
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('userAvatar').classList.remove('visible');
        document.getElementById('userAvatarPlaceholder').classList.remove('visible');
    }

    // ==================== –î–ê–ù–ù–´–ï ====================
    let currentDate = new Date();
    let tasks = {};
    let muscles = {};
    let collapsedCategories = {};
    let categories = [];
    // –ü—Ä–æ–≥—Ä–∞–º–º–∞: [{id, name, collapsed, exercises: [{id, name}]}]
    let program = [];
    let collapsedGroups = {};

    function loadCategories() {
        const saved = localStorage.getItem('categories');
        return saved ? JSON.parse(saved) : ['–°–ø–æ—Ä—Ç', '–°—Ç—É–¥–∏—è', '–î–Ω–µ–≤–Ω–∏–∫', '–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è', '–ö–æ–Ω—Ç–µ–Ω—Ç', '–†–µ–ª–∏–∑—ã'];
    }

    function saveCategories() {
        localStorage.setItem('categories', JSON.stringify(categories));
        if (isFirebaseEnabled && currentUserId) {
            database.ref('categories').set(categories);
        }
    }

    function saveProgram() {
        localStorage.setItem('program', JSON.stringify(program));
        if (isFirebaseEnabled && currentUserId) {
            database.ref('program').set(program);
        }
    }

    async function loadData() {
        if (isFirebaseEnabled && currentUserId) {
            try {
                const [tasksSnap, musclesSnap, catsSnap, progSnap] = await Promise.all([
                    database.ref('tasks').once('value'),
                    database.ref('muscles').once('value'),
                    database.ref('categories').once('value'),
                    database.ref('program').once('value'),
                ]);
                tasks = tasksSnap.val() || {};
                muscles = musclesSnap.val() || {};
                categories = catsSnap.val() || loadCategories();
                program = progSnap.val() || [];
                // Firebase –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç, –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤ ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
                if (program && !Array.isArray(program)) {
                    program = Object.values(program);
                }
                program.forEach(g => {
                    if (g.exercises && !Array.isArray(g.exercises)) {
                        g.exercises = Object.values(g.exercises);
                    }
                    if (!g.exercises) g.exercises = [];
                });
            } catch (e) {
                console.log('Firebase load error:', e);
                loadFromLocalStorage();
            }
        } else {
            loadFromLocalStorage();
        }
    }

    function loadFromLocalStorage() {
        const savedTasks = localStorage.getItem('taskTracker');
        const savedMuscles = localStorage.getItem('muscleTracker');
        const savedCollapsed = localStorage.getItem('collapsedCategories');
        const savedProgram = localStorage.getItem('program');
        tasks = savedTasks ? JSON.parse(savedTasks) : {};
        muscles = savedMuscles ? JSON.parse(savedMuscles) : {};
        collapsedCategories = savedCollapsed ? JSON.parse(savedCollapsed) : {};
        categories = loadCategories();
        program = savedProgram ? JSON.parse(savedProgram) : [];
    }

    function saveTasks() {
        localStorage.setItem('taskTracker', JSON.stringify(tasks));
        if (isFirebaseEnabled && currentUserId) database.ref('tasks').set(tasks);
    }

    function saveMuscles() {
        localStorage.setItem('muscleTracker', JSON.stringify(muscles));
        if (isFirebaseEnabled && currentUserId) database.ref('muscles').set(muscles);
    }

    function saveCollapsedState() {
        localStorage.setItem('collapsedCategories', JSON.stringify(collapsedCategories));
    }

    function getTaskKey(year, month, day, category) { return `${year}-${month}-${day}-${category}`; }
    function getMuscleKey(year, month, muscle) { return `${year}-${month}-${muscle}`; }
    function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

    // ==================== –ú–û–î–ê–õ–ö–ò ====================
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }

    document.addEventListener('click', function(e) {
        ['addCategoryModal', 'addGroupModal', 'addExerciseModal'].forEach(id => {
            if (e.target === document.getElementById(id)) closeModal(id);
        });
    });

    document.addEventListener('keypress', function(e) {
        if (e.key !== 'Enter') return;
        if (document.getElementById('addCategoryModal').classList.contains('active')) addNewCategory();
        else if (document.getElementById('addGroupModal').classList.contains('active')) addNewGroup();
        else if (document.getElementById('addExerciseModal').classList.contains('active')) addNewExercise();
    });

    // ==================== –ö–ê–¢–ï–ì–û–†–ò–ò ====================
    function openAddCategoryModal() {
        document.getElementById('newCategoryInput').value = '';
        openModal('addCategoryModal');
        setTimeout(() => document.getElementById('newCategoryInput').focus(), 100);
    }

    function addNewCategory() {
        const input = document.getElementById('newCategoryInput');
        const name = input.value.trim();
        if (!name) return;
        if (categories.includes(name)) { alert('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!'); return; }
        categories.push(name);
        saveCategories();
        closeModal('addCategoryModal');
        updateDisplay();
    }

    function toggleCategory(category) {
        const key = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${category}`;
        collapsedCategories[key] = !collapsedCategories[key];
        saveCollapsedState();
        updateDisplay();
    }

    // ==================== –ü–†–û–ì–†–ê–ú–ú–ê ====================
    function openAddGroupModal() {
        document.getElementById('newGroupInput').value = '';
        openModal('addGroupModal');
        setTimeout(() => document.getElementById('newGroupInput').focus(), 100);
    }

    function addNewGroup() {
        const name = document.getElementById('newGroupInput').value.trim();
        if (!name) return;
        program.push({ id: uid(), name, exercises: [], collapsed: false });
        saveProgram();
        closeModal('addGroupModal');
        renderProgram(); setTimeout(() => { initDragProgram(); initDragExercises(); }, 50);
    }

    function deleteGroup(groupId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É —Å–æ –≤—Å–µ–º–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏?')) return;
        program = program.filter(g => g.id !== groupId);
        saveProgram();
        renderProgram(); setTimeout(() => { initDragProgram(); initDragExercises(); }, 50);
    }

    function toggleGroup(groupId) {
        const g = program.find(g => g.id === groupId);
        if (!g) return;
        g.collapsed = !g.collapsed;
        // –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase —á—Ç–æ–±—ã –Ω–µ –ª–∏—à–Ω–∏–π —Ä–∞–∑ –ø–∏—Å–∞—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ
        renderProgram(); setTimeout(() => { initDragProgram(); initDragExercises(); }, 50);
    }

    function openAddExerciseModal(groupId) {
        document.getElementById('newExerciseInput').value = '';
        document.getElementById('newExerciseGroupId').value = groupId;
        openModal('addExerciseModal');
        setTimeout(() => document.getElementById('newExerciseInput').focus(), 100);
    }

    function addNewExercise() {
        const name = document.getElementById('newExerciseInput').value.trim();
        const groupId = document.getElementById('newExerciseGroupId').value;
        if (!name) return;
        const g = program.find(g => g.id === groupId);
        if (!g) return;
        g.exercises.push({ id: uid(), name });
        saveProgram();
        closeModal('addExerciseModal');
        renderProgram(); setTimeout(() => { initDragProgram(); initDragExercises(); }, 50);
    }

    function deleteExercise(groupId, exerciseId) {
        const g = program.find(g => g.id === groupId);
        if (!g) return;
        g.exercises = g.exercises.filter(e => e.id !== exerciseId);
        saveProgram();
        renderProgram(); setTimeout(() => { initDragProgram(); initDragExercises(); }, 50);
    }

    function renderProgram() {
        const grid = document.getElementById('programGrid');
        if (!grid) return;
        if (program.length === 0) {
            grid.innerHTML = '<div style="text-align:center;color:#666;padding:20px;font-size:14px;">–ù–µ—Ç –≥—Ä—É–ø–ø. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</div>';
            return;
        }
        grid.innerHTML = program.map(g => `
            <div class="program-group">
                <div class="program-group-header" onclick="toggleGroup('${g.id}')"
                     data-group-id="${g.id}">
                    <span class="drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å">‚†ø</span>
                    <span class="program-group-name">${escHtml(g.name)}</span>
                    <div class="program-group-actions" onclick="event.stopPropagation()">
                        <button class="program-icon-btn add" onclick="openAddExerciseModal('${g.id}')">+</button>
                        <button class="program-icon-btn delete" onclick="deleteGroup('${g.id}')">üóë</button>
                    </div>
                    <span class="program-group-toggle ${g.collapsed ? 'collapsed' : ''}">‚ñº</span>
                </div>
                <div class="program-group-body ${g.collapsed ? 'collapsed' : ''}">
                    ${g.exercises.length === 0 ? '<div style="padding:10px 12px;color:#666;font-size:13px;">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>' : ''}
                    ${g.exercises.map(ex => `
                        <div class="program-exercise" data-exercise-id="${ex.id}" data-group-id="${g.id}">
                            <span class="drag-handle ex-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å">‚†ø</span>
                            <span class="program-exercise-name">${escHtml(ex.name)}</span>
                            <div class="program-exercise-actions">
                                <button class="program-icon-btn delete" onclick="deleteExercise('${g.id}','${ex.id}')">üóë</button>
                            </div>
                        </div>
                    `).join('')}
                    <button class="program-add-exercise-btn" onclick="openAddExerciseModal('${g.id}')">+ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                </div>
            </div>
        `).join('');
    }

    function escHtml(str) {
        return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ==================== –¢–ê–ô–ú–ï–† ====================
    let timerSettings = { rounds: 5, work: 40, rest: 20, prep: 10 };
    let timerState = { phase: 'idle', round: 1, timeLeft: 0, paused: false };
    let timerInterval = null;
    const circumference = 553; // 2 * pi * 88

    function adjustSetting(key, delta) {
        const min = key === 'rounds' ? 1 : 5;
        const max = key === 'rounds' ? 20 : 300;
        timerSettings[key] = Math.max(min, Math.min(max, timerSettings[key] + delta));
        const labels = { rounds: '', work: ' —Å', rest: ' —Å', prep: ' —Å' };
        const ids = { rounds: 'settingRounds', work: 'settingWork', rest: 'settingRest', prep: 'settingPrep' };
        document.getElementById(ids[key]).textContent = timerSettings[key] + labels[key];
    }

    function startTimer() {
        document.getElementById('timerSettings').style.display = 'none';
        document.getElementById('timerActive').style.display = 'flex';
        document.getElementById('timerDone').style.display = 'none';
        timerState = { phase: 'prep', round: 1, timeLeft: timerSettings.prep, paused: false };
        updateTimerUI();
        runTick();
    }

    function runTick() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (timerState.paused) return;
            timerState.timeLeft--;
            if (timerState.timeLeft <= 0) {
                nextPhase();
            } else {
                updateTimerUI();
                // —Ç–∏–∫–∞–Ω—å–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 —Å–µ–∫—É–Ω–¥–∞—Ö
                if (timerState.timeLeft <= 5) {
                    tick();
                }
            }
        }, 1000);
    }

    function nextPhase() {
        if (timerState.phase === 'prep') {
            timerState.phase = 'work';
            timerState.timeLeft = timerSettings.work;
        } else if (timerState.phase === 'work') {
            if (timerState.round >= timerSettings.rounds) {
                // –ì–æ—Ç–æ–≤–æ!
                clearInterval(timerInterval);
                document.getElementById('timerActive').style.display = 'none';
                document.getElementById('timerDone').style.display = 'flex';
                beepDone();
                return;
            }
            timerState.phase = 'rest';
            timerState.timeLeft = timerSettings.rest;
        } else if (timerState.phase === 'rest') {
            timerState.round++;
            timerState.phase = 'work';
            timerState.timeLeft = timerSettings.work;
        }
        if (timerState.phase === 'work') beepWork();
        else if (timerState.phase === 'rest') beepRest();
        updateTimerUI();
    }

    function updateTimerUI() {
        const phase = timerState.phase;
        const total = phase === 'prep' ? timerSettings.prep
                    : phase === 'work' ? timerSettings.work
                    : timerSettings.rest;
        const progress = total > 0 ? timerState.timeLeft / total : 0;
        const offset = circumference * (1 - progress);

        document.getElementById('timerDigits').textContent = timerState.timeLeft;
        document.getElementById('timerRingProgress').style.strokeDashoffset = offset;

        const colors = { prep: '#888', work: '#ff6b35', rest: '#4caf50' };
        document.getElementById('timerRingProgress').style.stroke = colors[phase] || '#ff6b35';

        const labels = { prep: '–ü–û–î–ì–û–¢–û–í–ö–ê', work: '–†–ê–ë–û–¢–ê', rest: '–û–¢–î–´–•' };
        document.getElementById('timerPhaseLabel').textContent = labels[phase] || '';

        const restLabel = timerState.phase !== 'prep'
            ? '–†–∞—É–Ω–¥ ' + timerState.round + ' / ' + timerSettings.rounds
            : '–ì–æ—Ç–æ–≤—å—Å—è!';
        document.getElementById('timerRoundLabel').textContent = restLabel;
    }

    function togglePause() {
        timerState.paused = !timerState.paused;
        document.getElementById('timerPauseBtn').textContent = timerState.paused ? '‚ñ∂' : '‚è∏';
    }

    function stopTimer() {
        clearInterval(timerInterval);
        resetTimer();
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timerState = { phase: 'idle', round: 1, timeLeft: 0, paused: false };
        document.getElementById('timerSettings').style.display = 'block';
        document.getElementById('timerActive').style.display = 'none';
        document.getElementById('timerDone').style.display = 'none';
    }

    let audioCtx = null;
    function getAudioCtx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
    }

    function playTone(freq, duration, type = 'sine', vol = 0.4) {
        try {
            const ctx = getAudioCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(vol, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + duration);
        } catch(e) {}
    }

    // –∫–æ—Ä–æ—Ç–∫–æ–µ —Ç–∏–∫–∞–Ω—å–µ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–µ–∫
    function tick() {
        playTone(1000, 0.06, 'square', 0.15);
    }

    // —Å–º–µ–Ω–∞ –Ω–∞ –†–ê–ë–û–¢–£ ‚Äî –¥–≤–∞ –≤–æ—Å—Ö–æ–¥—è—â–∏—Ö —Ç–æ–Ω–∞
    function beepWork() {
        playTone(440, 0.12, 'sine', 0.5);
        setTimeout(() => playTone(660, 0.2, 'sine', 0.5), 140);
    }

    // —Å–º–µ–Ω–∞ –Ω–∞ –û–¢–î–´–• ‚Äî –Ω–∏—Å—Ö–æ–¥—è—â–∏–π —Ç–æ–Ω
    function beepRest() {
        playTone(660, 0.12, 'sine', 0.4);
        setTimeout(() => playTone(440, 0.25, 'sine', 0.3), 140);
    }

    // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–∫–∫–æ—Ä–¥
    function beepDone() {
        playTone(523, 0.15, 'sine', 0.5);
        setTimeout(() => playTone(659, 0.15, 'sine', 0.5), 160);
        setTimeout(() => playTone(784, 0.4, 'sine', 0.5), 320);
    }

    // ==================== –ú–´–®–¶–´ (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö) ====================
    const muscleGroups = ['–ü–ª–µ—á–∏','–¢—Ä–∏—Ü–µ–ø—Å','–ë–∏—Ü–µ–ø—Å','–û—Ç–∂–∏–º–∞–Ω–∏—è','–ü—Ä–µ—Å—Å','–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è','–ù–æ–≥–∏'];

    function incrementMuscle(year, month, muscle) {
        const key = getMuscleKey(year, month, muscle);
        muscles[key] = (muscles[key] || 0) + 1;
        saveMuscles(); renderMuscleTracker();
    }

    function decrementMuscle(year, month, muscle) {
        const key = getMuscleKey(year, month, muscle);
        if (muscles[key] > 0) {
            muscles[key]--;
            if (muscles[key] === 0) delete muscles[key];
            saveMuscles(); renderMuscleTracker();
        }
    }

    function resetMuscle(year, month, muscle) {
        delete muscles[getMuscleKey(year, month, muscle)];
        saveMuscles(); renderMuscleTracker();
    }

    function renderMuscleTracker() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const grid = document.getElementById('muscleGrid');
        grid.innerHTML = muscleGroups.map(muscle => {
            const key = getMuscleKey(year, month, muscle);
            const count = muscles[key] || 0;
            return `
                <div class="muscle-item ${count > 0 ? 'completed' : ''}">
                    <span class="muscle-name">${muscle}</span>
                    <div class="muscle-counter">
                        ${count > 0 ? `<div class="muscle-btn active" onclick="decrementMuscle(${year},${month},'${muscle}')">‚àí</div>` : '<div style="width:30px"></div>'}
                        <div class="muscle-count">${count > 0 ? count : ''}</div>
                        <div class="muscle-btn ${count > 0 ? 'active' : ''}" onclick="incrementMuscle(${year},${month},'${muscle}')">+</div>
                        ${count > 0 ? `<div class="muscle-reset" onclick="resetMuscle(${year},${month},'${muscle}')">√ó</div>` : '<div style="width:26px"></div>'}
                    </div>
                </div>`;
        }).join('');
    }

    // ==================== –ó–ê–î–ê–ß–ò ====================
    function toggleTask(year, month, day, category) {
        const key = getTaskKey(year, month, day, category);
        tasks[key] = !tasks[key];
        saveTasks(); updateDisplay();
    }

    function getCompletedCount(year, month, category) {
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let count = 0;
        for (let d = 1; d <= daysInMonth; d++) {
            if (tasks[getTaskKey(year, month, d, category)]) count++;
        }
        return count;
    }

    function renderTasks(year, month) {
        const grid = document.getElementById('tasksGrid');
        grid.innerHTML = '';
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay();
        const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
        const isDesktop = window.innerWidth >= 768;

        categories.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'task-category';
            const completed = getCompletedCount(year, month, category);
            const collapseKey = `${year}-${month}-${category}`;
            let isCollapsed;
            if (collapsedCategories.hasOwnProperty(collapseKey)) {
                isCollapsed = collapsedCategories[collapseKey];
            } else {
                isCollapsed = !isDesktop;
            }

            const counterDisplay = isCollapsed
                ? `<span class="category-count">${completed}</span>`
                : `<span class="category-count">${completed}/${daysInMonth}</span>`;

            categoryDiv.setAttribute('data-category', category);
            categoryDiv.innerHTML = `
                <div class="category-header">
                    <span class="category-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å">‚†ø</span>
                    <span class="category-name" onclick="toggleCategory('${category}')" style="flex:1;cursor:pointer">${category}</span>
                    <div style="display:flex;align-items:center;gap:8px;" onclick="toggleCategory('${category}')">
                        ${counterDisplay}
                        <span class="category-toggle ${isCollapsed ? 'collapsed' : ''}">‚ñº</span>
                    </div>
                </div>`;

            let weekHtml = '';
            let currentWeekDays = [];
            let weekNumber = 1;
            const dayNames = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];

            for (let i = 0; i < adjustedFirstDay; i++) {
                currentWeekDays.push('<div class="day-cell" style="opacity:0.3;"></div>');
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const key = getTaskKey(year, month, day, category);
                const isChecked = tasks[key] || false;
                const dayName = dayNames[(adjustedFirstDay + day - 1) % 7];
                currentWeekDays.push(`
                    <div class="day-cell">
                        <div class="day-label">${dayName}</div>
                        <input type="checkbox" class="day-checkbox" ${isChecked ? 'checked' : ''}
                               onchange="toggleTask(${year},${month},${day},'${category}')">
                    </div>`);

                if ((adjustedFirstDay + day) % 7 === 0 || day === daysInMonth) {
                    while (currentWeekDays.length < 7) {
                        currentWeekDays.push('<div class="day-cell" style="opacity:0.3;"></div>');
                    }
                    weekHtml += `
                        <div class="week-container">
                            <div class="week-header">–ù–µ–¥–µ–ª—è ${weekNumber}</div>
                            <div class="days-grid">${currentWeekDays.join('')}</div>
                        </div>`;
                    currentWeekDays = [];
                    weekNumber++;
                }
            }

            categoryDiv.innerHTML += `<div class="category-content ${isCollapsed ? 'collapsed' : ''}">${weekHtml}</div>`;
            grid.appendChild(categoryDiv);
        });
    }

    // ==================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================
    function updateMonthStats() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let total = 0, completed = 0;
        const categoryStats = {};
        categories.forEach(cat => categoryStats[cat] = { total: 0, completed: 0 });
        for (let day = 1; day <= daysInMonth; day++) {
            categories.forEach(cat => {
                categoryStats[cat].total++; total++;
                if (tasks[getTaskKey(year, month, day, cat)]) { categoryStats[cat].completed++; completed++; }
            });
        }
        document.getElementById('monthTotal').textContent = total;
        document.getElementById('monthCompleted').textContent = completed;
        document.getElementById('monthChart').innerHTML = categories.map(cat => {
            const p = categoryStats[cat].total > 0 ? (categoryStats[cat].completed / categoryStats[cat].total * 100).toFixed(0) : 0;
            return `<div class="bar-item"><div class="bar-label">${cat}</div><div class="bar-track"><div class="bar-fill" style="width:${p}%">${categoryStats[cat].completed}/${categoryStats[cat].total}</div></div></div>`;
        }).join('');
    }

    function updateYearStats() {
        const year = currentDate.getFullYear();
        const monthNames = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
        let totalYear = 0, completedYear = 0;
        const monthlyStats = [];
        for (let month = 0; month < 12; month++) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let mt = 0, mc = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                categories.forEach(cat => {
                    mt++; totalYear++;
                    if (tasks[getTaskKey(year, month, day, cat)]) { mc++; completedYear++; }
                });
            }
            monthlyStats.push({ name: monthNames[month], completed: mc, total: mt, percent: mt > 0 ? (mc/mt*100).toFixed(0) : 0 });
        }
        document.getElementById('yearTotal').textContent = totalYear;
        document.getElementById('yearCompleted').textContent = completedYear;
        document.getElementById('yearSummary').innerHTML = monthlyStats.map(m => `
            <div class="summary-item">
                <div class="summary-category">${m.name}</div>
                <div class="summary-stats">
                    <div class="summary-stat"><div class="summary-stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div><div class="summary-stat-value">${m.completed}/${m.total}</div></div>
                    <div class="summary-stat"><div class="summary-stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç</div><div class="summary-stat-value">${m.percent}%</div></div>
                </div>
            </div>`).join('');
    }

    // ==================== –ù–ê–í–ò–ì–ê–¶–ò–Ø ====================
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        updateDisplay();
    }

    function switchTab(tab, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        if (el) el.classList.add('active');
        document.getElementById(tab + 'Section').classList.add('active');

        if (tab === 'month') updateMonthStats();
        if (tab === 'year') updateYearStats();
        if (tab === 'program') { renderProgram(); setTimeout(() => { initDragProgram(); initDragExercises(); }, 50); }
    }

    function updateDisplay() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
        document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
        renderTasks(year, month);
        setTimeout(initDragCategories, 50);
    }

    window.addEventListener('resize', updateDisplay);


    // ==================== DRAG & DROP ====================
    let dragSrc = null;
    let dragType = null; // 'program' | 'category'

    function initDragProgram() {
        const grid = document.getElementById('programGrid');
        if (!grid) return;
        const groups = grid.querySelectorAll('.program-group');

        groups.forEach(el => {
            const handle = el.querySelector('.drag-handle');
            if (!handle) return;

            // Desktop
            handle.addEventListener('mousedown', () => { el.setAttribute('draggable', 'true'); });
            el.addEventListener('dragstart', e => {
                dragSrc = el; dragType = 'program';
                setTimeout(() => el.classList.add('dragging'), 10);
            });
            el.addEventListener('dragend', () => {
                el.classList.remove('dragging');
                el.removeAttribute('draggable');
                grid.querySelectorAll('.drag-over-top,.drag-over-bottom').forEach(x => {
                    x.classList.remove('drag-over-top','drag-over-bottom');
                });
            });
            el.addEventListener('dragover', e => {
                e.preventDefault();
                if (dragSrc === el) return;
                const rect = el.getBoundingClientRect();
                const mid = rect.top + rect.height / 2;
                el.classList.remove('drag-over-top','drag-over-bottom');
                el.classList.add(e.clientY < mid ? 'drag-over-top' : 'drag-over-bottom');
            });
            el.addEventListener('dragleave', () => {
                el.classList.remove('drag-over-top','drag-over-bottom');
            });
            el.addEventListener('drop', e => {
                e.preventDefault();
                if (!dragSrc || dragSrc === el) return;
                const rect = el.getBoundingClientRect();
                const before = e.clientY < rect.top + rect.height / 2;
                const srcId = dragSrc.querySelector('.program-group-header').dataset.groupId;
                const tgtId = el.querySelector('.program-group-header').dataset.groupId;
                const srcIdx = program.findIndex(g => g.id === srcId);
                const tgtIdx = program.findIndex(g => g.id === tgtId);
                if (srcIdx === -1 || tgtIdx === -1) return;
                const [item] = program.splice(srcIdx, 1);
                const newIdx = program.findIndex(g => g.id === tgtId);
                program.splice(before ? newIdx : newIdx + 1, 0, item);
                saveProgram();
                renderProgram();
                initDragProgram();
            });

            // Touch
            setupTouchDrag(handle, el, 'program');
        });
    }

    function initDragCategories() {
        const grid = document.getElementById('tasksGrid');
        if (!grid) return;
        const items = grid.querySelectorAll('.task-category');

        items.forEach(el => {
            const handle = el.querySelector('.category-handle');
            if (!handle) return;

            handle.addEventListener('mousedown', () => { el.setAttribute('draggable', 'true'); });
            el.addEventListener('dragstart', e => {
                dragSrc = el; dragType = 'category';
                setTimeout(() => el.classList.add('dragging'), 10);
            });
            el.addEventListener('dragend', () => {
                el.classList.remove('dragging');
                el.removeAttribute('draggable');
                grid.querySelectorAll('.drag-over-top,.drag-over-bottom').forEach(x => {
                    x.classList.remove('drag-over-top','drag-over-bottom');
                });
            });
            el.addEventListener('dragover', e => {
                e.preventDefault();
                if (dragSrc === el) return;
                const rect = el.getBoundingClientRect();
                el.classList.remove('drag-over-top','drag-over-bottom');
                el.classList.add(e.clientY < rect.top + rect.height / 2 ? 'drag-over-top' : 'drag-over-bottom');
            });
            el.addEventListener('dragleave', () => {
                el.classList.remove('drag-over-top','drag-over-bottom');
            });
            el.addEventListener('drop', e => {
                e.preventDefault();
                if (!dragSrc || dragSrc === el) return;
                const rect = el.getBoundingClientRect();
                const before = e.clientY < rect.top + rect.height / 2;
                const srcCat = dragSrc.dataset.category;
                const tgtCat = el.dataset.category;
                const srcIdx = categories.indexOf(srcCat);
                const tgtIdx = categories.indexOf(tgtCat);
                if (srcIdx === -1 || tgtIdx === -1) return;
                categories.splice(srcIdx, 1);
                const newIdx = categories.indexOf(tgtCat);
                categories.splice(before ? newIdx : newIdx + 1, 0, srcCat);
                saveCategories();
                updateDisplay();
                initDragCategories();
            });

            setupTouchDrag(handle, el, 'category');
        });
    }

    // Touch drag ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∞–π—Ñ–æ–Ω–µ
    function setupTouchDrag(handle, el, type) {
        let ghost = null;
        let startY = 0;
        let lastOver = null;

        handle.addEventListener('touchstart', e => {
            startY = e.touches[0].clientY;
            dragSrc = el; dragType = type;
            el.classList.add('dragging');

            ghost = el.cloneNode(true);
            ghost.style.cssText = `position:fixed;left:${el.getBoundingClientRect().left}px;top:${el.getBoundingClientRect().top}px;width:${el.offsetWidth}px;opacity:0.8;z-index:9999;pointer-events:none;transform:scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,0.5);border-radius:12px;`;
            document.body.appendChild(ghost);
        }, { passive: true });

        handle.addEventListener('touchmove', e => {
            e.preventDefault();
            const t = e.touches[0];
            if (ghost) {
                ghost.style.top = (t.clientY - el.offsetHeight / 2) + 'px';
            }
            const below = document.elementFromPoint(t.clientX, t.clientY);
            const targetEl = below ? below.closest(type === 'program' ? '.program-group' : '.task-category') : null;
            if (lastOver && lastOver !== targetEl) {
                lastOver.classList.remove('drag-over-top','drag-over-bottom');
            }
            if (targetEl && targetEl !== el) {
                const rect = targetEl.getBoundingClientRect();
                targetEl.classList.remove('drag-over-top','drag-over-bottom');
                targetEl.classList.add(t.clientY < rect.top + rect.height / 2 ? 'drag-over-top' : 'drag-over-bottom');
                lastOver = targetEl;
            }
        }, { passive: false });

        handle.addEventListener('touchend', e => {
            if (ghost) { ghost.remove(); ghost = null; }
            el.classList.remove('dragging');
            if (lastOver) {
                const before = lastOver.classList.contains('drag-over-top');
                lastOver.classList.remove('drag-over-top','drag-over-bottom');

                if (type === 'program') {
                    const srcId = dragSrc.querySelector('.program-group-header').dataset.groupId;
                    const tgtId = lastOver.querySelector('.program-group-header').dataset.groupId;
                    const srcIdx = program.findIndex(g => g.id === srcId);
                    const tgtIdx = program.findIndex(g => g.id === tgtId);
                    if (srcIdx !== -1 && tgtIdx !== -1 && srcIdx !== tgtIdx) {
                        const [item] = program.splice(srcIdx, 1);
                        const newIdx = program.findIndex(g => g.id === tgtId);
                        program.splice(before ? newIdx : newIdx + 1, 0, item);
                        saveProgram();
                        renderProgram(); setTimeout(() => { initDragProgram(); initDragExercises(); }, 50);
                        initDragProgram();
                    }
                } else {
                    const srcCat = dragSrc.dataset.category;
                    const tgtCat = lastOver.dataset.category;
                    const srcIdx = categories.indexOf(srcCat);
                    if (srcIdx !== -1 && srcCat !== tgtCat) {
                        categories.splice(srcIdx, 1);
                        const newIdx = categories.indexOf(tgtCat);
                        categories.splice(before ? newIdx : newIdx + 1, 0, srcCat);
                        saveCategories();
                        updateDisplay();
                        initDragCategories();
                    }
                }
            }
            dragSrc = null; lastOver = null;
        });
    }


    function initDragExercises() {
        document.querySelectorAll('.program-group').forEach(groupEl => {
            const groupId = groupEl.querySelector('.program-group-header').dataset.groupId;
            const exercises = groupEl.querySelectorAll('.program-exercise');

            exercises.forEach(el => {
                const handle = el.querySelector('.ex-handle');
                if (!handle) return;

                // Desktop drag
                handle.addEventListener('mousedown', () => el.setAttribute('draggable', 'true'));
                el.addEventListener('dragstart', e => {
                    dragSrc = el; dragType = 'exercise';
                    setTimeout(() => el.classList.add('dragging'), 10);
                });
                el.addEventListener('dragend', () => {
                    el.classList.remove('dragging');
                    el.removeAttribute('draggable');
                    groupEl.querySelectorAll('.drag-over-top,.drag-over-bottom').forEach(x =>
                        x.classList.remove('drag-over-top','drag-over-bottom'));
                });
                el.addEventListener('dragover', e => {
                    e.preventDefault();
                    if (dragSrc === el || dragType !== 'exercise') return;
                    const rect = el.getBoundingClientRect();
                    el.classList.remove('drag-over-top','drag-over-bottom');
                    el.classList.add(e.clientY < rect.top + rect.height / 2 ? 'drag-over-top' : 'drag-over-bottom');
                });
                el.addEventListener('dragleave', () =>
                    el.classList.remove('drag-over-top','drag-over-bottom'));
                el.addEventListener('drop', e => {
                    e.preventDefault();
                    if (!dragSrc || dragSrc === el || dragType !== 'exercise') return;
                    const srcGroupId = dragSrc.dataset.groupId;
                    const tgtGroupId = el.dataset.groupId;
                    if (srcGroupId !== tgtGroupId) return; // —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã
                    const srcExId = dragSrc.dataset.exerciseId;
                    const tgtExId = el.dataset.exerciseId;
                    const g = program.find(g => g.id === srcGroupId);
                    if (!g) return;
                    const rect = el.getBoundingClientRect();
                    const before = e.clientY < rect.top + rect.height / 2;
                    const srcIdx = g.exercises.findIndex(ex => ex.id === srcExId);
                    const [item] = g.exercises.splice(srcIdx, 1);
                    const newIdx = g.exercises.findIndex(ex => ex.id === tgtExId);
                    g.exercises.splice(before ? newIdx : newIdx + 1, 0, item);
                    saveProgram();
                    renderProgram();
                    setTimeout(() => { initDragProgram(); initDragExercises(); }, 50);
                });

                // Touch
                setupTouchDragExercise(handle, el, groupId);
            });
        });
    }

    function setupTouchDragExercise(handle, el, groupId) {
        let ghost = null;
        let lastOver = null;

        handle.addEventListener('touchstart', e => {
            dragSrc = el; dragType = 'exercise';
            el.classList.add('dragging');
            ghost = el.cloneNode(true);
            const r = el.getBoundingClientRect();
            ghost.style.cssText = `position:fixed;left:${r.left}px;top:${r.top}px;width:${el.offsetWidth}px;opacity:0.8;z-index:9999;pointer-events:none;transform:scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,0.5);border-radius:8px;background:#2a2a2a;`;
            document.body.appendChild(ghost);
        }, { passive: true });

        handle.addEventListener('touchmove', e => {
            e.preventDefault();
            const t = e.touches[0];
            if (ghost) ghost.style.top = (t.clientY - el.offsetHeight / 2) + 'px';
            const below = document.elementFromPoint(t.clientX, t.clientY);
            const targetEl = below ? below.closest('.program-exercise') : null;
            if (lastOver && lastOver !== targetEl)
                lastOver.classList.remove('drag-over-top','drag-over-bottom');
            if (targetEl && targetEl !== el && targetEl.dataset.groupId === groupId) {
                const rect = targetEl.getBoundingClientRect();
                targetEl.classList.remove('drag-over-top','drag-over-bottom');
                targetEl.classList.add(t.clientY < rect.top + rect.height / 2 ? 'drag-over-top' : 'drag-over-bottom');
                lastOver = targetEl;
            }
        }, { passive: false });

        handle.addEventListener('touchend', () => {
            if (ghost) { ghost.remove(); ghost = null; }
            el.classList.remove('dragging');
            if (lastOver) {
                const before = lastOver.classList.contains('drag-over-top');
                lastOver.classList.remove('drag-over-top','drag-over-bottom');
                const tgtExId = lastOver.dataset.exerciseId;
                const srcExId = el.dataset.exerciseId;
                const g = program.find(g => g.id === groupId);
                if (g && srcExId !== tgtExId) {
                    const srcIdx = g.exercises.findIndex(ex => ex.id === srcExId);
                    const [item] = g.exercises.splice(srcIdx, 1);
                    const newIdx = g.exercises.findIndex(ex => ex.id === tgtExId);
                    g.exercises.splice(before ? newIdx : newIdx + 1, 0, item);
                    saveProgram();
                    renderProgram();
                    setTimeout(() => { initDragProgram(); initDragExercises(); }, 50);
                }
            }
            dragSrc = null; lastOver = null;
        });
    }

    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    function initApp() {
        if (isFirebaseEnabled && auth) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    onUserSignedIn(user);
                } else {
                    onUserSignedOut();
                }
            });
        } else {
            // –ë–µ–∑ Firebase ‚Äî –ø—Ä–æ—Å—Ç–æ –≥—Ä—É–∑–∏–º –∏–∑ localStorage
            loadData().then(() => { updateDisplay(); });
        }
    }

    initApp();
</script>
</body>
</html>
